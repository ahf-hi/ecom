<!DOCTYPE html>
<html>

<head>

    <link rel="stylesheet" href="../css/form.css">
    
</head>

<div class="controls">
<body> 

 <form id="form" method="post" action="" >


   <label for="MPI_TRANS_TYPE">MPI_TRANS_TYPE (Transaction Type):</label>
	<select type="text" name="MPI_TRANS_TYPE">
      <option value="INQ">INQ</option>
      <option value="VSALES">VSALES</option>
      <option value="REFUND">REFUND</option>
      <option value="SALESCOMPL">SALESCOMPL</option>
      <option value="RECURR">RECURR</option>
      <option value="TERMINATE">TERMINATE</option> 
    </select>
	
	<label for="MPI_MERC_ID">MPI_MERC_ID (MID):</label>
    <input type="text" name="MPI_MERC_ID" maxlength="15" >
	
	<label for="MPI_PURCH_DATE">MPI_PURCH_DATE (Datetime):</label>
    <input type="text" name="MPI_PURCH_DATE" maxlength="14" >
	
	<label for="MPI_TRXN_ID">MPI_TRXN_ID (Transaction ID):</label>
    <input type="text" name="MPI_TRXN_ID" maxlength="20" >
	
	<label for="MPI_ORI_TRXN_ID">MPI_ORI_TRXN_ID (Original Transaction ID):</label>
    <input type="text" name="MPI_ORI_TRXN_ID" maxlength="20" >

	<label for="MPI_PURCH_CURR">MPI_PURCH_CURR (Currency: MYR only)):</label>
    <input type="text" name="MPI_PURCH_CURR" value = '458' maxlength="3" >
	
	<label for="MPI_PURCH_AMT">MPI_PURCH_AMT (Amount):</label>
    <input type="text" name="MPI_PURCH_AMT" maxlength="19" >
	
	<label for="MPI_MAC"> MPI_MAC (Signed MAC):</label>
    <textarea type="text" name="MPI_MAC" maxlength="344" rows="5" cols="90" ></textarea>

 </form>
    
 
   <button onclick="clear_mac()" >Clear MAC</button><br>
      <textarea id = "mac" rows="1" cols="90" ></textarea><br> 
  
   <button onclick="trim_mac()" >Trim MAC</button><br><br>
   
   <button onclick="mkReq()">Key Exhcange </button>
   <button onclick="mpReq()">Pay </button><br><br>	
</div>

<div id="frontend-display" style="display:none; margin: 20px; border: 2px solid #000; padding: 20px;">
    <h2>Payment Summary</h2>
    <p>MID: <span id="view-mid"></span></p>
    <p>TRXN ID: <span id="view-txid"></span></p>
    <div id="action-area"></div>
</div>

<form id="redirect-form" method="POST" style="display:none;"></form>

</body>

<script>

const KEY_EXCHANGE_URL = "https://linkv2.paydee.co/mpigw/mkReq";
const PAYMENT_REQUEST_URL = "https://linkv2.paydee.co/mpigw/mpReq";

document.getElementById("form").action = PAYMENT_REQUEST_URL;

function mkReq() 
{
 let MID =  document.forms["form"]["MPI_MERC_ID"].value
 let transactionID =  document.forms["form"]["MPI_TRXN_ID"].value
 
 var myHeaders = new Headers();
    myHeaders.append("Content-Type", "application/json");

 var raw = JSON.stringify({
    "merchantId": MID,
    "pubKey": "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAq8j2SHHfzMLlhYppnlk-QqjjjZwMkhK6s6rERd0JhhY_6-Md4Z0327uEdfNbJrSEPJVPT55gjRhx4MorEhrabuafuY8thSPS4epwkOjjPtELwZxViWe1dzG5TQakJ_i8ZOQuUYFJg02RcwUTzE3ty-x7mkwj9t2wAdRqTagyaDIAVMTxP_Y4AS76xjA3aH43Q0HKHGAxxIlXBIQxImuPhlUbPtVtTHIsUwkIx2BDh8kPZ3Mgr3Cyky0F-cHpEFSi3rPSSLD_FVHlJRW2cODVm8E-s98CURQYs1npzDztzZgZPnnb9K57CB2Z50Ve6qUV7z4-uHs3nehiMJHktIs7LQIDAQAB",
    "purchaseId": transactionID
 });

 var requestOptions = {
    method: 'POST',
    headers: myHeaders,
    mode: 'no-cors',
    body: raw,
    redirect: 'follow'
 };

 fetch(KEY_EXCHANGE_URL, requestOptions)
  .then(response => response.json())
  .then(commits => alert(commits[0].author.login));
  
} 

async function mpReq() {
    const form = document.getElementById("form");
    const payButton = document.querySelector("button[onclick='mpReq()']");
    
    // 1. Prepare data and exclude empty fields
    const formData = new FormData(form);
    const cleanedData = new URLSearchParams();
    for (const [key, value] of formData.entries()) {
        if (value.trim() !== "") {
            cleanedData.append(key, value);
        }
    }

    payButton.disabled = true;
    payButton.innerText = "Processing...";

    try {
        // 2. Use fetch to catch the response
        const response = await fetch(PAYMENT_REQUEST_URL, {
            method: 'POST',
            body: cleanedData,
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
        });

        const contentType = response.headers.get("content-type");

        // 3. Handle JSON (Frontend Response)
        if (contentType && contentType.includes("application/json")) {
            const data = await response.json();
            showFrontendUI(data);
        } 
        // 4. Handle HTML (Vercel Server Response)
        else {
            const htmlResult = await response.text();
            document.body.innerHTML = htmlResult; 
        }

    } catch (error) {
        console.error("Error:", error);
        alert("Request failed. Check console for CORS errors.");
    } finally {
        payButton.disabled = false;
        payButton.innerText = "Pay";
    }
}

function showFrontendUI(data) {
    document.getElementById('frontend-display').style.display = 'block';
    document.getElementById('view-mid').innerText = data.MPI_MERC_ID;
    document.getElementById('view-txid').innerText = data.MPI_TRXN_ID;

    const actionArea = document.getElementById('action-area');
    
    if (data.MPI_REDIRECT_URL) {
        actionArea.innerHTML = `<button onclick="submitToBank('${data.MPI_REDIRECT_URL}', '${data.MPI_REDIRECT_HTTP_DATA}')">Proceed to Bank</button>`;
    } else {
        actionArea.innerHTML = `<p>Transaction processed. No redirect required.</p>`;
    }
}


function clear_mac() 
{
  document.getElementById("mac").innerHTML = 
    document.forms["form"]["MPI_TRANS_TYPE"].value 
  + document.forms["form"]["MPI_MERC_ID"].value 
  + document.forms["form"]["MPI_TRXN_ID"].value
  + document.forms["form"]["MPI_ORI_TRXN_ID"].value
  + document.forms["form"]["MPI_PURCH_DATE"].value
  + document.forms["form"]["MPI_PURCH_CURR"].value
  + document.forms["form"]["MPI_PURCH_AMT"].value;
}

function trim_mac() {
  let macElement = document.forms["form"]["MPI_MAC"];
  
  let rawMac = macElement.value;
  
  let trimmedMac = rawMac.replace(/[+]/g, "-")
                         .replace(/[/]/g, "_")
                         .replace(/[=]/g, "");
  
  macElement.value = trimmedMac;
}

let d = new Date();
let year = d.getFullYear() ;
let mth  = d.getMonth() +1;
 mth = mth.toString().padStart(2, '0');
let day = d.getDate() ;
 day = day.toString().padStart(2, '0');
let hrs = d.getHours() ;
 hrs = hrs.toString().padStart(2, '0');
let min = d.getMinutes() ;
 min = min.toString().padStart(2, '0');
let sec = d.getSeconds() ;
 sec = sec.toString().padStart(2, '0');
 
let x = year + mth + day + hrs + min + sec;
document.forms["form"]["MPI_PURCH_DATE"].value = x;

let y = "PAGUAT" + x;
document.forms["form"]["MPI_TRXN_ID"].value = y;

	
</script>

</html>


