<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="../css/form.css">
    <title>Process Redirect</title>
</head>
<body> 
    <div class="controls">
        <form id="form">
            <label for="MPI_REDIRECT_HTTP_METHOD">MPI_REDIRECT_HTTP_METHOD:</label>
            <input type="text" name="MPI_REDIRECT_HTTP_METHOD" id="MPI_REDIRECT_HTTP_METHOD" maxlength="15">

            <label for="MPI_REDIRECT_URL">MPI_REDIRECT_URL (URL):</label>
            <textarea name="MPI_REDIRECT_URL" id="MPI_REDIRECT_URL" maxlength="300" rows="3" cols="100"></textarea>

            <label for="MPI_REDIRECT_HTTP_DATA">MPI_REDIRECT_HTTP_DATA (http body):</label>
            <textarea name="MPI_REDIRECT_HTTP_DATA" id="MPI_REDIRECT_HTTP_DATA" maxlength="2000" rows="20" cols="100"></textarea>
        </form>
        
        <button onclick="redirect()">Redirect to Provider</button>
    </div>

    <script>
        // 1. Automatically grab data from the URL parameters on page load
        const params = new URLSearchParams(window.location.search);
        const fields = ['MPI_REDIRECT_HTTP_METHOD', 'MPI_REDIRECT_URL', 'MPI_REDIRECT_HTTP_DATA'];

        fields.forEach(field => {
            const value = params.get(field);
            if (value) {
                document.getElementById(field).value = value;
            }
        });

        // 2. The redirect logic
        function redirect() {
            const url = document.getElementById("MPI_REDIRECT_URL").value.trim();   
            const mtd = document.getElementById("MPI_REDIRECT_HTTP_METHOD").value.trim() || "POST";
            const dataRaw = document.getElementById("MPI_REDIRECT_HTTP_DATA").value.trim();

            if (!url) {
                alert("Error: MPI_REDIRECT_URL is empty.");
                return;
            }

            // Create a dynamic form to handle the submission
            let mapForm = document.createElement("form");
            mapForm.method = mtd;
            mapForm.action = url;
            
            // This ensures we break out of any iframe and load the provider in the full window
            mapForm.target = "_top"; 

            // Check if there is actual data to send
            if (dataRaw !== "") {
                try {
                    let jsonData = JSON.parse(dataRaw);
                    for (let key in jsonData) {
                        if (jsonData.hasOwnProperty(key)) {
                            let input = document.createElement("input");
                            input.type = "hidden";
                            input.name = key;
                            input.value = jsonData[key];
                            mapForm.appendChild(input);
                        }
                    }
                } catch (e) {
                    // If the field has text but it's not valid JSON
                    alert("JSON Parse Error: " + e.message);
                    return; 
                }
            }
            // If dataRaw is empty, the code above is skipped, and mapForm submits with no extra fields

            document.body.appendChild(mapForm);
            mapForm.submit();
        }
    </script>
</body>
</html>
