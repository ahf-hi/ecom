<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/form.css">
    <title>Payment Page</title>
</head>
<body> 
    <div class="controls">
        <form id="form" method="post" action="">
            <input type="hidden" name="MPI_RETURN_URL" id="MPI_RETURN_URL" value="">

            <label for="MPI_TRANS_TYPE">MPI_TRANS_TYPE (Transaction Type):</label>
            <select name="MPI_TRANS_TYPE" id="MPI_TRANS_TYPE">
                <option value="SALES">SALES</option>
                <option value="INITRECURR">INITRECURR</option>
                <option value="PRERECURR">PRERECURR</option>
                <option value="PREAUTH">PREAUTH</option>
            </select>

            <label for="MPI_MERC_ID">MPI_MERC_ID (MID):</label>
            <input type="text" name="MPI_MERC_ID" id="MPI_MERC_ID" maxlength="15">

            <label for="MPI_PURCH_DATE">MPI_PURCH_DATE (Datetime) :</label>
            <input type="text" name="MPI_PURCH_DATE" id="MPI_PURCH_DATE" maxlength="14">

            <label for="MPI_TRXN_ID">MPI_TRXN_ID (Transaction ID):</label>
            <input type="text" name="MPI_TRXN_ID" id="MPI_TRXN_ID" maxlength="20">

            <label for="MPI_PURCH_CURR">MPI_PURCH_CURR (Currency: MYR only):</label>
            <input type="text" name="MPI_PURCH_CURR" id="MPI_PURCH_CURR" value='458' maxlength="3">

            <label for="MPI_PURCH_AMT">MPI_PURCH_AMT (Amount):</label>
            <input type="text" name="MPI_PURCH_AMT" id="MPI_PURCH_AMT" maxlength="19">

            <label for="MPI_RESPONSE_TYPE">MPI_RESPONSE_TYPE:</label>
            <select name="MPI_RESPONSE_TYPE" id="MPI_RESPONSE_TYPE">
                <option value=""></option>
                <option value="JSON">JSON</option>
                <option value="STRING">STRING</option>
            </select>
            
            <label for="MPI_PAYMENT_CHANNEL_ID">MPI_PAYMENT_CHANNEL_ID:</label>
            <input type="text" name="MPI_PAYMENT_CHANNEL_ID" id="MPI_PAYMENT_CHANNEL_ID" maxlength="30">

            <label for="MPI_MAC">MPI_MAC (Signed MAC) :</label>
            <textarea name="MPI_MAC" id="MPI_MAC" maxlength="344" rows="5" cols="100"></textarea>
        </form>

        <hr>
        <button onclick="clear_mac()">Clear MAC</button><br>
        <textarea id="mac" rows="1" cols="90" readonly></textarea><br> 

        <button onclick="trim_mac()">Trim MAC</button><br><br>

        <button onclick="mkReq()">Key Exchange</button>
        <button type="button" onclick="mpReq()">Pay</button><br><br>

        <form id="redirect-form" method="POST" style="display:none;"></form>
    </div>

    <script>
        // --- CONFIGURATION ---
        const KEY_EXCHANGE_URL = "https://devlinkv2.paydee.co/mpigw/mkReq";
        const PAYMENT_REQUEST_URL = "https://devlinkv2.paydee.co/mpigw/mpReq";
        const GET_CHANNEL_URL = "https://devlinkv2.paydee.co/mpigw/channels";
        const PUBLICKEY = "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAq8j2SHHfzMLlhYppnlk-QqjjjZwMkhK6s6rERd0JhhY_6-Md4Z0327uEdfNbJrSEPJVPT55gjRhx4MorEhrabuafuY8thSPS4epwkOjjPtELwZxViWe1dzG5TQakJ_i8ZOQuUYFJg02RcwUTzE3ty-x7mkwj9t2wAdRqTagyaDIAVMTxP_Y4AS76xjA3aH43Q0HKHGAxxIlXBIQxImuPhlUbPtVtTHIsUwkIx2BDh8kPZ3Mgr3Cyky0F-cHpEFSi3rPSSLD_FVHlJRW2cODVm8E-s98CURQYs1npzDztzZgZPnnb9K57CB2Z50Ve6qUV7z4-uHs3nehiMJHktIs7LQIDAQAB";
		const VERCEL_CALLBACK_URL = "https://sys-int-nine.vercel.app/api/callback"


        // Initialize form action
        document.getElementById("form").action = PAYMENT_REQUEST_URL;

        /**
         * MP REQ - Main Payment Submission
         * Uses native form submission to Gateway to avoid CORS errors.
         */
        function mpReq() {
            const form = document.getElementById("form");
            const payButton = document.querySelector("button[onclick='mpReq()']");

            // 1. Set the Return URL so Gateway knows where to go after processing
            document.getElementById("MPI_RETURN_URL").value = VERCEL_CALLBACK_URL;

            // 2. Loop through all fields and disable empty ones (essential for correct MAC)
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (!input.value.trim()) {
                    input.disabled = true;
                }
            });

            payButton.disabled = true;
            payButton.innerText = "Redirecting to Gateway...";

            // 3. Submit form normally (Bypasses CORS restrictions)
            form.submit();

            // 4. Re-enable after delay in case user navigates back
            setTimeout(() => {
                inputs.forEach(input => input.disabled = false);
                payButton.disabled = false;
                payButton.innerText = "Pay";
            }, 2000);
        }

        /**
         * MK REQ - Key Exchange
         * Handles the background communication for keys.
         */
        async function mkReq() {
            let MID = document.forms["form"]["MPI_MERC_ID"].value;
            let transactionID = document.forms["form"]["MPI_TRXN_ID"].value;

            const myHeaders = new Headers();
            myHeaders.append("Content-Type", "application/json");

            const raw = JSON.stringify({
                "merchantId": MID,
                "pubKey": PUBLICKEY,
                "purchaseId": transactionID
            });

            const requestOptions = {
                method: 'POST',
                headers: myHeaders,
                body: raw
            };

            try {
                const response = await fetch(KEY_EXCHANGE_URL, requestOptions);
                const result = await response.json(); 

                if (result.errorCode === "000") {
                    alert(`✅ Success!\nCode: ${result.errorCode}\nMessage: ${result.errorMessage || 'Key Exchange successful.'}`);
                } else {
                    alert(`❌ Key Exchange Failed\nError Code: ${result.errorCode}\nMessage: ${result.errorMessage || 'Error'}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert("⚠️ Connection Blocked: Check if the server allows CORS for fetch requests.");
            }
        }

        /**
         * MAC UTILITIES
         */
        function clear_mac() {
            document.getElementById("mac").innerHTML = 
                document.forms["form"]["MPI_TRANS_TYPE"].value + 
                document.forms["form"]["MPI_MERC_ID"].value + 
                document.forms["form"]["MPI_TRXN_ID"].value +
                document.forms["form"]["MPI_PURCH_DATE"].value +
                document.forms["form"]["MPI_PURCH_CURR"].value +
                document.forms["form"]["MPI_PURCH_AMT"].value +
                document.forms["form"]["MPI_RESPONSE_TYPE"].value +
                document.forms["form"]["MPI_PAYMENT_CHANNEL_ID"].value;
        }

        function trim_mac() {
            let macElement = document.forms["form"]["MPI_MAC"];
            let rawMac = macElement.value;
            let trimmedMac = rawMac.replace(/[+]/g, "-")
                                   .replace(/[/]/g, "_")
                                   .replace(/[=]/g, "");
            macElement.value = trimmedMac;
        }

        /**
         * DATE & ID INITIALIZATION
         */
        function initFields() {
            let d = new Date();
            let x = d.getFullYear() + 
                    (d.getMonth() + 1).toString().padStart(2, '0') + 
                    d.getDate().toString().padStart(2, '0') + 
                    d.getHours().toString().padStart(2, '0') + 
                    d.getMinutes().toString().padStart(2, '0') + 
                    d.getSeconds().toString().padStart(2, '0');
            
            document.forms["form"]["MPI_PURCH_DATE"].value = x;
            document.forms["form"]["MPI_TRXN_ID"].value = "PAGUAT" + x;
        }

        // Run on load
        initFields();

    </script>
</body>
</html>
